name: üê≥ Docker Build, Push, and Deploy (Next.js)

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ecommerce-frontend
  REGISTRY: ghcr.io
  DOCKER_COMPOSE_PATH: /home/deployer/industrialmart-deployment/docker-compose.yml
  DOCKER_SERVICE_NAME: frontend
  # Using secrets for host info is more secure than hardcoding IPs
  SERVER_USER_HOST: ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      sha_tag: ${{ steps.get_sha_tag.outputs.sha_tag }}

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=sha-,format=short
            type=raw,value=latest,enable=true

      - name: üî® Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            NEXT_PUBLIC_IMAGE_BASE_URL=${{ secrets.NEXT_PUBLIC_IMAGE_BASE_URL }}
            NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }}

      - name: üìÑ Get unique SHA tag
        id: get_sha_tag
        run: |
          # Extract just the sha-xxxx part for use in the deploy job
          SHA_TAG=$(echo "${{ steps.meta.outputs.tags }}" | grep -o 'sha-[a-z0-9]\{7\}' | head -n 1)
          echo "sha_tag=$SHA_TAG" >> $GITHUB_OUTPUT

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: üîë Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üö¢ Deploy and Rollback Logic
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          NEW_IMAGE="${{ env.REGISTRY }}/$REPO_LOWER/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.sha_tag }}"
          
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER_HOST }} << EOF
            set -e
            
            DEPLOY_DIR=\$(dirname ${{ env.DOCKER_COMPOSE_PATH }})
            COMPOSE_FILE=\$(basename ${{ env.DOCKER_COMPOSE_PATH }})
            PREVIOUS_TAG_FILE="\$DEPLOY_DIR/last_known_good_tag.txt"
            
            cd \$DEPLOY_DIR

            # Log in to Registry on VPS
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

            # 1. Capture the currently running tag BEFORE we change anything
            # This allows us to roll back if the NEW deployment fails.
            if [ -f "\$PREVIOUS_TAG_FILE" ]; then
              OLD_TAG=\$(cat "\$PREVIOUS_TAG_FILE")
            else
              OLD_TAG="latest"
            fi

            echo "Current stable version is: \$OLD_TAG"
            echo "Attempting to deploy: $NEW_IMAGE"

            # 2. Update Compose and Pull
            docker pull $NEW_IMAGE
            sed -i "s|image: .*/${{ env.IMAGE_NAME }}:.*|image: $NEW_IMAGE|" "\$COMPOSE_FILE"
            
            # 3. Start the service
            docker compose -f "\$COMPOSE_FILE" up -d --no-deps ${{ env.DOCKER_SERVICE_NAME }}

            # 4. Health Check
            echo "Waiting 20s for service to stabilize..."
            sleep 20
            
            HEALTH_STATUS=\$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "failed")

            if [ "\$HEALTH_STATUS" = "200" ]; then
              echo "‚úÖ Health check passed! Updating stable tag to ${{ needs.build-and-push.outputs.sha_tag }}"
              echo "${{ needs.build-and-push.outputs.sha_tag }}" > "\$PREVIOUS_TAG_FILE"
            else
              echo "‚ùå Health check failed with status \$HEALTH_STATUS. Rolling back..."
              
              ROLLBACK_IMAGE="${{ env.REGISTRY }}/$REPO_LOWER/${{ env.IMAGE_NAME }}:\$OLD_TAG"
              
              docker pull \$ROLLBACK_IMAGE
              sed -i "s|image: .*/${{ env.IMAGE_NAME }}:.*|image: \$ROLLBACK_IMAGE|" "\$COMPOSE_FILE"
              docker compose -f "\$COMPOSE_FILE" up -d --no-deps ${{ env.DOCKER_SERVICE_NAME }}
              
              echo "‚ö†Ô∏è Rollback to \$OLD_TAG complete."
              exit 1
            fi
          EOF